apiVersion: v1
kind: Service
metadata:
  name: agent
spec:
  type: ClusterIP
  selector:
    app: agent
  ports:
    - port: 8001
      targetPort: 8001
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent
spec:
  replicas: 3
  selector:
    matchLabels:
      app: agent
  template:
    metadata:
      labels:
        app: agent
    spec:
      containers:
        - name: agent
          image: agent:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8001
          envFrom:
            - configMapRef:
                name: agent-env
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "1000m"
          startupProbe:
            httpGet:
              path: /health
              port: 8001
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 12
          livenessProbe:
            httpGet:
              path: /health
              port: 8001
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8001
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2
      restartPolicy: Always
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: agent-scaledobject
spec:
  scaleTargetRef:
    name: agent
  minReplicaCount: 3
  maxReplicaCount: 110
  pollingInterval: 15
  cooldownPeriod: 60
  idleReplicaCount: 1
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 60
          policies:
            - type: Percent
              value: 50
              periodSeconds: 30
            - type: Pods
              value: 2
              periodSeconds: 60
          selectPolicy: Min
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
            - type: Percent
              value: 100
              periodSeconds: 15
            - type: Pods
              value: 4
              periodSeconds: 15
          selectPolicy: Max
  triggers:
    # CPU-based scaling for compute-intensive AI operations
    - type: cpu
      metricType: Utilization
      metadata:
        value: "70"
    # Memory-based scaling for session/conversation management
    - type: memory
      metricType: Utilization
      metadata:
        value: "80"
    # Prometheus metrics for custom application metrics
    # Uncomment when Prometheus is available with agent metrics
    # - type: prometheus
    #   metadata:
    #     serverAddress: http://prometheus.default.svc:9090
    #     metricName: agent_http_requests_per_second
    #     threshold: "50"
    #     query: |
    #       rate(http_requests_total{job="agent"}[1m])
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: agent-vpa
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: Deployment
    name: agent
  updatePolicy:
    updateMode: "Recreate"  # Recreate pods with updated resources
  resourcePolicy:
    containerPolicies:
      - containerName: agent
        mode: Auto
        minAllowed:
          cpu: 200m
          memory: 256Mi
        maxAllowed:
          cpu: 4000m
          memory: 2Gi
        controlledResources:
          - cpu
          - memory
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: agent-pdb
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: agent
---
